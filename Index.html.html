<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Approvisionnements</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            border: 1px solid #e8e8e8;
        }

        .header {
            background: linear-gradient(135deg, #4a5f4f 0%, #6b8068 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .tabs {
            display: flex;
            background: #fafafa;
            border-bottom: 1px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            background: #fafafa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            color: #666;
        }

        .tab:hover {
            background: #f0f0f0;
        }

        .tab.active {
            background: white;
            color: #4a5f4f;
            border-bottom: 3px solid #6b8068;
        }

        .tab-content {
            display: none;
            padding: 30px;
            animation: fadeIn 0.3s;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #fafafa;
            border-radius: 8px;
            border-left: 4px solid #6b8068;
        }

        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }

        input[type="text"],
        input[type="number"],
        input[type="file"] {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border 0.3s;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: #6b8068;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-top: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4a5f4f 0%, #6b8068 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 95, 79, 0.3);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        th {
            background: linear-gradient(135deg, #4a5f4f 0%, #6b8068 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #667eea;
        }

        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .action-btn {
            padding: 6px 12px;
            font-size: 14px;
            margin: 2px;
        }

        .highlight-red {
            background: #ffebee !important;
        }

        .highlight-green {
            background: #e8f5e9 !important;
        }

        .highlight-yellow {
            background: #fff9c4 !important;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .file-input-label:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .file-name {
            display: inline-block;
            margin-left: 10px;
            color: #666;
            font-style: italic;
        }

        .grid-2col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .grid-2col {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state i {
            font-size: 3em;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display: flex; align-items: center; justify-content: center; gap: 20px;">
                <img src="logo-dr-hauschka.png" 
                     alt="Dr. Hauschka" 
                     style="height: 50px; background: white; padding: 10px; border-radius: 8px;"
                     onerror="this.style.display='none'">
                <div>
                    <h1 style="margin: 0;">üöö Gestion des Approvisionnements</h1>
                    <p style="margin: 5px 0 0 0;">Syst√®me de gestion automatis√© des stocks et commandes</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('referentiel')">üìã R√©f√©rentiel Produits</button>
            <button class="tab" onclick="switchTab('import')">üì• Import Donn√©es</button>
            <button class="tab" onclick="switchTab('calcul')">üßÆ Calcul Commande</button>
            <button class="tab" onclick="switchTab('confirmation')">‚úÖ Order Confirmation</button>
            <button class="tab" onclick="switchTab('alertes')">‚ö†Ô∏è Alertes Stock</button>
            <button class="tab" onclick="switchTab('dashboard')">üìä Dashboard</button>
        </div>

        <!-- TAB 1: R√âF√âRENTIEL PRODUITS -->
        <div id="referentiel" class="tab-content active">
            <div class="section">
                <h2>Ajouter un produit</h2>
                <div class="grid-2col">
                    <div class="form-group">
                        <label>R√©f√©rence FR: <span style="color: red;">*</span></label>
                        <input type="text" id="refFR" placeholder="Ex: FR001">
                    </div>
                    <div class="form-group">
                        <label>R√©f√©rence ALL: <span style="color: #999;">(optionnel)</span></label>
                        <input type="text" id="refALL" placeholder="Ex: DE001">
                    </div>
                </div>
                <div class="form-group">
                    <label>D√©signation: <span style="color: red;">*</span></label>
                    <input type="text" id="designation" placeholder="Ex: Produit X">
                </div>
                <div class="grid-2col">
                    <div class="form-group">
                        <label>Prix d'achat (‚Ç¨):</label>
                        <input type="number" step="0.01" id="prixAchat" placeholder="Ex: 12.50">
                    </div>
                    <div class="form-group">
                        <label>Colisage:</label>
                        <input type="number" id="colisage" placeholder="Ex: 12">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="ajouterProduit()">‚ûï Ajouter le produit</button>
                <button class="btn btn-info" onclick="importerReferentiel()">üì• Importer r√©f√©rentiel (CSV/Excel)</button>
                <button class="btn btn-success" onclick="exporterReferentiel()">üì§ Exporter r√©f√©rentiel</button>
            </div>

            <div class="section">
                <h2>Liste des produits</h2>
                <div class="search-box">
                    <input type="text" id="searchRef" placeholder="üîç Rechercher un produit..." oninput="filtrerReferentiel()">
                </div>
                <div id="listeReferentiel"></div>
            </div>
        </div>

        <!-- TAB 2: IMPORT DONN√âES -->
        <div id="import" class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è Format attendu:</strong> Fichiers CSV ou Excel avec colonnes: R√©f FR ou R√©f ALL, et les donn√©es correspondantes
            </div>

            <div class="section">
                <h2>üì¶ Import Stock Actuel</h2>
                <p style="margin-bottom: 15px; color: #666;">Colonnes attendues: R√©f FR (ou R√©f ALL) | Stock</p>
                <div class="file-input-wrapper">
                    <input type="file" id="fileStock" accept=".csv,.xlsx,.xls" onchange="updateFileName('fileStock', 'fileNameStock')">
                    <label for="fileStock" class="file-input-label">Choisir un fichier</label>
                    <span class="file-name" id="fileNameStock">Aucun fichier s√©lectionn√©</span>
                </div>
                <button class="btn btn-primary" onclick="importerStock()">üì• Importer Stock</button>
            </div>

            <div class="section">
                <h2>üìä Import Consommation Mensuelle</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    <strong>Format attendu:</strong> Colonne A avec r√©f√©rence entre crochets [XXXXX] + colonnes avec mois (janvier 2024, f√©vrier 2024, etc.)<br>
                    <strong>üìê Calcul:</strong> Moyenne automatique sur les <strong>12 derniers mois</strong> √† partir du mois actuel<br>
                    <em>Exemple: [1820102] Cr√®me pour les Mains | janvier 2024 | f√©vrier 2024 | ...</em>
                </p>
                <div class="file-input-wrapper">
                    <input type="file" id="fileConso" accept=".csv,.xlsx,.xls" onchange="updateFileName('fileConso', 'fileNameConso')">
                    <label for="fileConso" class="file-input-label">Choisir un fichier</label>
                    <span class="file-name" id="fileNameConso">Aucun fichier s√©lectionn√©</span>
                </div>
                <button class="btn btn-primary" onclick="importerConso()">üì• Importer Conso</button>
            </div>

            <div class="section">
                <h2>üìà Import Forecast</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    <strong>Colonnes attendues:</strong> R√©f FR | R√©f ALL | D√©signation | J | F | M | A | M | J | J | A | S | O | N | D<br>
                    <em>Initiales accept√©es: J (Janvier), F (F√©vrier), M (Mars), A (Avril), etc.</em>
                </p>
                <div class="form-group">
                    <label><strong>üìÖ S√©lectionnez le mois pour lequel vous passez commande :</strong></label>
                    <select id="moisForecast" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 16px;">
                        <option value="0">Janvier (J)</option>
                        <option value="1">F√©vrier (F)</option>
                        <option value="2">Mars (M)</option>
                        <option value="3">Avril (A)</option>
                        <option value="4">Mai (M)</option>
                        <option value="5">Juin (J)</option>
                        <option value="6">Juillet (J)</option>
                        <option value="7">Ao√ªt (A)</option>
                        <option value="8">Septembre (S)</option>
                        <option value="9">Octobre (O)</option>
                        <option value="10">Novembre (N)</option>
                        <option value="11">D√©cembre (D)</option>
                    </select>
                </div>
                <div class="file-input-wrapper">
                    <input type="file" id="fileForecast" accept=".csv,.xlsx,.xls" onchange="updateFileName('fileForecast', 'fileNameForecast')">
                    <label for="fileForecast" class="file-input-label">Choisir un fichier</label>
                    <span class="file-name" id="fileNameForecast">Aucun fichier s√©lectionn√©</span>
                </div>
                <button class="btn btn-primary" onclick="importerForecast()">üì• Importer Forecast</button>
            </div>

            <div class="section">
                <h2>üìã √âtat des imports</h2>
                <div id="etatImports"></div>
            </div>
        </div>

        <!-- TAB 3: CALCUL COMMANDE -->
        <div id="calcul" class="tab-content">
            <div class="alert alert-info">
                <strong>üìê Nouvelle formule optimis√©e:</strong><br>
                1Ô∏è‚É£ Conso sur 20 jours = (Conso mensuelle √∑ 30) √ó 20 jours<br>
                2Ô∏è‚É£ Stock au 5 novembre = Stock actuel - Conso sur 20 jours<br>
                3Ô∏è‚É£ Besoin au 5 novembre = 2 √ó Conso mensuelle<br>
                4Ô∏è‚É£ <strong>Qt√© √† commander = Besoin - Stock au 5 nov + Forecast</strong><br>
                <br>
                üìÖ <em>Commande pass√©e le 15 ‚Üí R√©ception le 5 du mois suivant (20 jours)</em>
            </div>

            <div class="section">
                <h2>‚öôÔ∏è R√®gles sp√©ciales</h2>
                <p style="margin-bottom: 15px; color: #666;">
                    Pour certains produits, vous pouvez d√©finir une commande bas√©e <strong>uniquement sur le forecast</strong> (sans r√©assort automatique).
                </p>
                
                <div class="form-group">
                    <label>S√©lectionnez les produits √† commander uniquement sur forecast :</label>
                    <select id="selectProduitRegle" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 5px; font-size: 14px;">
                        <option value="">-- Choisir un produit --</option>
                    </select>
                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="ajouterRegleSpeciale()">‚ûï Ajouter cette r√®gle</button>
                </div>

                <div class="form-group" style="margin-top: 20px;">
                    <label><strong>Produits en mode "Forecast Only" :</strong></label>
                    <div id="listeReglesSpeciales" style="margin-top: 10px; padding: 15px; background: #f9f9f9; border-radius: 5px; min-height: 50px;">
                        <em style="color: #999;">Aucune r√®gle d√©finie</em>
                    </div>
                </div>

                <div id="messageRegles" style="margin-top: 10px;"></div>
            </div>

            <div class="section">
                <button class="btn btn-primary" onclick="calculerCommande()">üßÆ Calculer les besoins</button>
                <button class="btn btn-success" onclick="exporterCommande()">üì§ Exporter la commande</button>
                <button class="btn btn-warning" onclick="reinitialiserDonnees()">üîÑ R√©initialiser les donn√©es</button>
            </div>

            <div class="section">
                <h2>R√©sultats du calcul</h2>
                <div id="resultatCalcul"></div>
            </div>
        </div>

        <!-- TAB 4: ORDER CONFIRMATION -->
        <div id="confirmation" class="tab-content">
            <div class="alert alert-info">
                <strong>‚ÑπÔ∏è √âtape:</strong> Importez l'Order Confirmation du fournisseur<br>
                üìä <strong>Colonnes utilis√©es automatiquement :</strong><br>
                ‚Ä¢ Colonne <strong>G</strong> : Article-No. (R√©f ALL)<br>
                ‚Ä¢ Colonne <strong>J</strong> : Quantity order<br>
                ‚Ä¢ Colonne <strong>K</strong> : Quantity available<br>
                <em>Le syst√®me prendra la colonne K si disponible, sinon la colonne J</em>
            </div>

            <div class="section">
                <h2>üì• Import Order Confirmation</h2>
                <p style="margin-bottom: 15px; color: #666;">Importez directement votre fichier Excel du fournisseur (format original)</p>
                <div class="file-input-wrapper">
                    <input type="file" id="fileConfirmation" accept=".csv,.xlsx,.xls" onchange="updateFileName('fileConfirmation', 'fileNameConfirmation')">
                    <label for="fileConfirmation" class="file-input-label">Choisir un fichier</label>
                    <span class="file-name" id="fileNameConfirmation">Aucun fichier s√©lectionn√©</span>
                </div>
                <button class="btn btn-primary" onclick="importerConfirmation()">üì• Importer & Comparer</button>
            </div>

            <div class="section">
                <h2>üìä Comparaison Commande vs Confirmation</h2>
                <div id="resultatConfirmation"></div>
            </div>
        </div>

        <!-- TAB 5: ALERTES STOCK -->
        <div id="alertes" class="tab-content">
            <div class="section">
                <h2>‚ö†Ô∏è Pr√©vision & Alerte de Stock</h2>
                <p>Simulez l'√©volution de vos stocks jusqu'√† votre prochaine r√©ception</p>
                
                <div class="grid-2col">
                    <div class="form-group">
                        <label>üìÖ Date de la prochaine r√©ception:</label>
                        <input type="date" id="dateReception" onchange="calculerAlertes()">
                    </div>
                    <div class="form-group">
                        <label>üìä Afficher:</label>
                        <select id="filtreAlertes" onchange="calculerAlertes()">
                            <option value="tous">Tous les produits</option>
                            <option value="rupture">‚õî Rupture actuelle uniquement</option>
                            <option value="alerte">‚ö†Ô∏è Alerte stock (risque rupture)</option>
                            <option value="critique">üî¥ Critique (rupture + alerte)</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="calculerAlertes()">üîç Analyser les stocks</button>
                    <button class="btn btn-success" onclick="exporterAlertes()">üì• Exporter les alertes</button>
                </div>
            </div>

            <div class="section">
                <h2>üìä R√©sultats de l'analyse</h2>
                <div id="statsAlertes" style="margin-bottom: 20px;"></div>
                <div class="search-box">
                    <input type="text" id="searchAlertes" placeholder="üîç Rechercher un produit..." oninput="filtrerAlertes()">
                </div>
                <div id="tableauAlertes"></div>
            </div>
        </div>

        <!-- TAB 6: DASHBOARD -->
        <div id="dashboard" class="tab-content">
            <div class="section">
                <h2>üìä Vue d'ensemble</h2>
                <div class="stats-grid" id="statsGrid"></div>
            </div>

            <div class="section">
                <h2>üìã Tableau complet</h2>
                <div class="search-box">
                    <input type="text" id="searchDashboard" placeholder="üîç Rechercher..." oninput="filtrerDashboard()">
                </div>
                <div id="tableauComplet"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        // Base de donn√©es locale
        let database = {
            produits: [],
            stocks: {},
            conso: {},
            forecast: {},
            commande: {},
            confirmation: {},
            confirmationDetails: {}, // D√©tails des colonnes J et K
            reglesSpeciales: {
                forecastOnly: [] // Liste des r√©f√©rences √† commander uniquement sur forecast
            }
        };

        // Charger les donn√©es au d√©marrage
        window.onload = function() {
            chargerDonnees();
            afficherReferentiel();
            afficherEtatImports();
            afficherDashboard();
            
            // D√©finir le mois actuel par d√©faut dans le s√©lecteur de forecast
            const moisActuel = new Date().getMonth();
            const selectMois = document.getElementById('moisForecast');
            if (selectMois) {
                selectMois.value = moisActuel.toString();
            }
            
            // Charger les r√®gles sp√©ciales
            chargerReglesSpeciales();
        };

        // Fonction pour peupler la liste d√©roulante des produits
        function peuplerSelectProduits() {
            const select = document.getElementById('selectProduitRegle');
            if (!select) return;
            
            // Garder l'option par d√©faut
            select.innerHTML = '<option value="">-- Choisir un produit --</option>';
            
            // Ajouter tous les produits
            database.produits.forEach(produit => {
                const option = document.createElement('option');
                option.value = produit.refFR;
                option.textContent = `${produit.refFR} - ${produit.designation}`;
                select.appendChild(option);
            });
        }

        // Fonction pour ajouter une r√®gle sp√©ciale
        function ajouterRegleSpeciale() {
            const select = document.getElementById('selectProduitRegle');
            const refFR = select.value;
            
            if (!refFR) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un produit');
                return;
            }
            
            // Initialiser si n√©cessaire
            if (!database.reglesSpeciales) {
                database.reglesSpeciales = { forecastOnly: [] };
            }
            if (!database.reglesSpeciales.forecastOnly) {
                database.reglesSpeciales.forecastOnly = [];
            }
            
            // V√©rifier si la r√®gle existe d√©j√†
            if (database.reglesSpeciales.forecastOnly.includes(refFR)) {
                alert('‚ö†Ô∏è Cette r√®gle existe d√©j√† pour ce produit');
                return;
            }
            
            // Ajouter la r√®gle
            database.reglesSpeciales.forecastOnly.push(refFR);
            sauvegarderDonnees();
            afficherReglesSpeciales();
            
            // R√©initialiser le select
            select.value = '';
            
            const messageDiv = document.getElementById('messageRegles');
            messageDiv.innerHTML = `<div class="alert alert-success">‚úÖ R√®gle ajout√©e pour ${refFR}</div>`;
            setTimeout(() => {
                messageDiv.innerHTML = '';
            }, 2000);
        }

        // Fonction pour supprimer une r√®gle sp√©ciale
        function supprimerRegleSpeciale(refFR) {
            if (confirm(`‚ö†Ô∏è Supprimer la r√®gle "Forecast Only" pour ${refFR} ?`)) {
                const index = database.reglesSpeciales.forecastOnly.indexOf(refFR);
                if (index > -1) {
                    database.reglesSpeciales.forecastOnly.splice(index, 1);
                    sauvegarderDonnees();
                    afficherReglesSpeciales();
                }
            }
        }

        // Fonction pour afficher la liste des r√®gles sp√©ciales
        function afficherReglesSpeciales() {
            const container = document.getElementById('listeReglesSpeciales');
            if (!container) return;
            
            if (!database.reglesSpeciales || !database.reglesSpeciales.forecastOnly || database.reglesSpeciales.forecastOnly.length === 0) {
                container.innerHTML = '<em style="color: #999;">Aucune r√®gle d√©finie</em>';
                return;
            }
            
            let html = '';
            database.reglesSpeciales.forecastOnly.forEach(refFR => {
                const produit = database.produits.find(p => p.refFR === refFR);
                const designation = produit ? produit.designation : 'Produit non trouv√©';
                
                html += `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: white; border-radius: 5px; margin-bottom: 8px; border-left: 4px solid #667eea;">
                        <div>
                            <strong style="color: #667eea;">üéØ ${refFR}</strong> - ${designation}
                        </div>
                        <button class="btn btn-danger action-btn" onclick="supprimerRegleSpeciale('${refFR}')">üóëÔ∏è Supprimer</button>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Fonction pour charger les r√®gles sp√©ciales au d√©marrage
        function chargerReglesSpeciales() {
            peuplerSelectProduits();
            afficherReglesSpeciales();
        }

        // Fonction pour v√©rifier si une r√©f√©rence est en mode forecast only
        function estForecastOnly(refFR) {
            if (!database.reglesSpeciales || !database.reglesSpeciales.forecastOnly) {
                return false;
            }
            return database.reglesSpeciales.forecastOnly.includes(refFR);
        }

        // Gestion des onglets
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            // Rafra√Æchir l'affichage si n√©cessaire
            if (tabName === 'referentiel') afficherReferentiel();
            if (tabName === 'import') afficherEtatImports();
            if (tabName === 'dashboard') afficherDashboard();
        }

        // Sauvegarder dans localStorage
        function sauvegarderDonnees() {
            localStorage.setItem('appro_database', JSON.stringify(database));
        }

        // Charger depuis localStorage
        function chargerDonnees() {
            const saved = localStorage.getItem('appro_database');
            if (saved) {
                database = JSON.parse(saved);
            }
        }

        // R√âF√âRENTIEL PRODUITS
        function ajouterProduit() {
            const refFR = document.getElementById('refFR').value.trim();
            const refALL = document.getElementById('refALL').value.trim();
            const designation = document.getElementById('designation').value.trim();
            const colisage = document.getElementById('colisage').value.trim();
            const prixAchat = document.getElementById('prixAchat').value.trim();

            if (!refFR || !designation) {
                alert('‚ö†Ô∏è Veuillez remplir au moins les champs R√©f FR et D√©signation');
                return;
            }

            // V√©rifier si la r√©f√©rence existe d√©j√†
            const existe = database.produits.find(p => 
                p.refFR === refFR || (refALL && p.refALL === refALL)
            );
            
            if (existe) {
                alert('‚ö†Ô∏è Cette r√©f√©rence existe d√©j√† dans la base de donn√©es');
                return;
            }

            database.produits.push({
                refFR,
                refALL: refALL || 'N/A',
                designation,
                prixAchat: prixAchat ? parseFloat(prixAchat) : null,
                colisage: colisage ? parseInt(colisage) : null
            });

            sauvegarderDonnees();
            afficherReferentiel();

            // R√©initialiser le formulaire
            document.getElementById('refFR').value = '';
            document.getElementById('refALL').value = '';
            document.getElementById('designation').value = '';
            document.getElementById('prixAchat').value = '';
            document.getElementById('colisage').value = '';

            alert('‚úÖ Produit ajout√© avec succ√®s !');
        }

        function afficherReferentiel() {
            const container = document.getElementById('listeReferentiel');
            
            if (database.produits.length === 0) {
                container.innerHTML = '<div class="empty-state">üì¶ Aucun produit dans le r√©f√©rentiel. Ajoutez-en un ci-dessus !</div>';
                return;
            }

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>R√©f FR</th>
                            <th>R√©f ALL</th>
                            <th>D√©signation</th>
                            <th>Prix d'achat (‚Ç¨)</th>
                            <th>Colisage</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            database.produits.forEach((produit, index) => {
                html += `
                    <tr>
                        <td><strong>${produit.refFR}</strong></td>
                        <td>${produit.refALL}</td>
                        <td>${produit.designation}</td>
                        <td>${produit.prixAchat ? produit.prixAchat.toFixed(2) + ' ‚Ç¨' : '-'}</td>
                        <td>${produit.colisage || '-'}</td>
                        <td>
                            <button class="btn btn-danger action-btn" onclick="supprimerProduit(${index})">üóëÔ∏è Supprimer</button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
            
            // Rafra√Æchir aussi la liste d√©roulante des r√®gles sp√©ciales
            peuplerSelectProduits();
        }

        function filtrerReferentiel() {
            const search = document.getElementById('searchRef').value.toLowerCase();
            const rows = document.querySelectorAll('#listeReferentiel tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function supprimerProduit(index) {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir supprimer ce produit ?')) {
                const produit = database.produits[index];
                
                // Supprimer aussi les donn√©es associ√©es
                delete database.stocks[produit.refFR];
                delete database.conso[produit.refFR];
                delete database.forecast[produit.refFR];
                delete database.commande[produit.refFR];
                
                database.produits.splice(index, 1);
                sauvegarderDonnees();
                afficherReferentiel();
                alert('‚úÖ Produit supprim√©');
            }
        }

        // IMPORT FICHIERS
        function updateFileName(inputId, displayId) {
            const input = document.getElementById(inputId);
            const display = document.getElementById(displayId);
            display.textContent = input.files.length > 0 ? input.files[0].name : 'Aucun fichier s√©lectionn√©';
        }

        function trouverProduit(ref) {
            return database.produits.find(p => p.refFR === ref || p.refALL === ref);
        }

        function importerStock() {
            const fileInput = document.getElementById('fileStock');
            if (!fileInput.files.length) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Lire les donn√©es brutes sans en-t√™te pour acc√©der aux colonnes par index
                    const rawData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});

                    console.log('Import stock - Nombre de lignes:', rawData.length);
                    console.log('Exemple de ligne:', rawData[1]); // Ligne 2 (apr√®s en-t√™te)

                    let imported = 0;
                    let errors = [];
                    let notFound = [];

                    // Ignorer la premi√®re ligne (en-t√™te) et commencer √† la ligne 2
                    for (let i = 1; i < rawData.length; i++) {
                        const row = rawData[i];
                        
                        // Colonne B = index 1 (R√©f FR)
                        // Colonne E = index 4 (R√©f ALL)
                        // Colonne G = index 6 (Stock dispo)
                        const refFR = row[1];
                        const refALL = row[4];
                        const stock = row[6];

                        if (stock !== undefined && stock !== '' && stock !== null) {
                            let produit = null;
                            let refUtilisee = '';
                            
                            // Essayer d'abord avec la r√©f√©rence FR (colonne B)
                            if (refFR && refFR !== '' && refFR !== 'NaN' && refFR !== 'nan') {
                                const refFRStr = refFR.toString().trim();
                                produit = trouverProduit(refFRStr);
                                refUtilisee = refFRStr;
                            }
                            
                            // Si pas trouv√© avec r√©f FR, essayer avec r√©f ALL (colonne E)
                            if (!produit && refALL && refALL !== '' && refALL !== 'NaN' && refALL !== 'nan') {
                                const refALLStr = refALL.toString().trim();
                                produit = trouverProduit(refALLStr);
                                refUtilisee = refALLStr;
                            }
                            
                            if (produit) {
                                const stockValue = parseFloat(stock);
                                if (!isNaN(stockValue)) {
                                    database.stocks[produit.refFR] = stockValue;
                                    imported++;
                                    console.log(`‚úì ${produit.refFR}: stock = ${stockValue}`);
                                } else {
                                    errors.push(`Ligne ${i + 1}: Valeur de stock invalide "${stock}" pour ${refUtilisee}`);
                                }
                            } else {
                                if (refUtilisee) {
                                    notFound.push(`Ligne ${i + 1}: R√©f√©rence "${refUtilisee}" non trouv√©e dans le r√©f√©rentiel`);
                                }
                            }
                        }
                    }

                    sauvegarderDonnees();
                    afficherEtatImports();
                    
                    let message = '';
                    
                    if (imported > 0) {
                        message += `‚úÖ Import termin√©!\n\n`;
                        message += `‚Ä¢ ${imported} produits import√©s avec succ√®s\n`;
                        message += `\nüìç Colonnes utilis√©es:\n`;
                        message += `  ‚Ä¢ Colonne B : R√©f FR\n`;
                        message += `  ‚Ä¢ Colonne E : R√©f ALL\n`;
                        message += `  ‚Ä¢ Colonne G : Stock disponible\n`;
                    } else {
                        message += `‚ö†Ô∏è Aucun stock import√©!\n\n`;
                    }
                    
                    if (notFound.length > 0) {
                        message += `\n‚ö†Ô∏è ${notFound.length} r√©f√©rences non trouv√©es dans le r√©f√©rentiel:\n`;
                        message += notFound.slice(0, 5).join('\n');
                        if (notFound.length > 5) message += `\n... et ${notFound.length - 5} autres`;
                    }
                    
                    if (errors.length > 0) {
                        message += `\n‚ùå ${errors.length} erreurs:\n`;
                        message += errors.slice(0, 5).join('\n');
                        if (errors.length > 5) message += `\n... et ${errors.length - 5} autres`;
                    }
                    
                    if (imported === 0 && rawData.length > 1) {
                        message += `\n\nüí° V√©rifiez que votre fichier contient bien:`;
                        message += `\n‚Ä¢ Colonne B : R√©f FR`;
                        message += `\n‚Ä¢ Colonne E : R√©f ALL`;
                        message += `\n‚Ä¢ Colonne G : Stock disponible`;
                    }
                    
                    alert(message);
                } catch (error) {
                    console.error('Erreur import stock:', error);
                    alert('‚ùå Erreur lors de la lecture du fichier:\n' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function importerConso() {
            const fileInput = document.getElementById('fileConso');
            if (!fileInput.files.length) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: false, defval: ''});

                    console.log('Import conso - Nombre de lignes:', rows.length);
                    console.log('En-t√™tes:', rows[0]);

                    // Trouver la ligne d'en-t√™te avec les mois
                    let headerRowIndex = -1;
                    let colonnesMois = {};
                    
                    for (let i = 0; i < Math.min(5, rows.length); i++) {
                        const row = rows[i];
                        for (let j = 0; j < row.length; j++) {
                            const cell = (row[j] || '').toString().toLowerCase();
                            if (cell.includes('janvier') || cell.includes('f√©vrier') || cell.includes('mars') || 
                                cell.includes('jan') || cell.includes('fev') || cell.includes('f√©v') ||
                                cell.includes('2024') || cell.includes('2025')) {
                                headerRowIndex = i;
                                break;
                            }
                        }
                        if (headerRowIndex >= 0) break;
                    }

                    if (headerRowIndex < 0) {
                        alert('‚ö†Ô∏è Impossible de trouver la ligne d\'en-t√™te avec les mois');
                        return;
                    }

                    // Parser les en-t√™tes pour identifier les colonnes de mois
                    const headers = rows[headerRowIndex];
                    const moisRegex = /(janvier|f√©vrier|fevrier|mars|avril|mai|juin|juillet|ao√ªt|aout|septembre|octobre|novembre|d√©cembre|decembre)\s*(\d{4})/i;
                    const moisAbregRegex = /(jan|f√©v|fev|mar|avr|mai|jun|juil|jul|ao√ª|aou|sep|oct|nov|d√©c|dec).*(\d{4})/i;
                    
                    for (let colIndex = 0; colIndex < headers.length; colIndex++) {
                        const header = (headers[colIndex] || '').toString().trim();
                        let match = header.match(moisRegex) || header.match(moisAbregRegex);
                        
                        if (match) {
                            const moisNom = match[1].toLowerCase();
                            const annee = parseInt(match[2]);
                            
                            // Convertir le nom du mois en num√©ro
                            const moisMap = {
                                'janvier': 0, 'jan': 0,
                                'f√©vrier': 1, 'fevrier': 1, 'f√©v': 1, 'fev': 1,
                                'mars': 2, 'mar': 2,
                                'avril': 3, 'avr': 3,
                                'mai': 4,
                                'juin': 5, 'jun': 5,
                                'juillet': 6, 'juil': 6, 'jul': 6,
                                'ao√ªt': 7, 'aout': 7, 'ao√ª': 7, 'aou': 7,
                                'septembre': 8, 'sep': 8, 'sept': 8,
                                'octobre': 9, 'oct': 9,
                                'novembre': 10, 'nov': 10,
                                'd√©cembre': 11, 'decembre': 11, 'd√©c': 11, 'dec': 11
                            };
                            
                            const moisNum = moisMap[moisNom];
                            if (moisNum !== undefined) {
                                const date = new Date(annee, moisNum, 1);
                                colonnesMois[colIndex] = date;
                                console.log(`Colonne ${colIndex}: ${header} => ${date.toLocaleDateString('fr-FR', {month: 'long', year: 'numeric'})}`);
                            }
                        }
                    }

                    if (Object.keys(colonnesMois).length === 0) {
                        alert('‚ö†Ô∏è Aucune colonne de mois d√©tect√©e dans le fichier');
                        return;
                    }

                    // Stocker toutes les consos par produit
                    const consoParProduit = {};

                    // Parser les lignes de donn√©es (apr√®s l'en-t√™te)
                    for (let i = headerRowIndex + 1; i < rows.length; i++) {
                        const row = rows[i];
                        if (!row || row.length === 0) continue;
                        
                        // Extraire la r√©f√©rence de la premi√®re colonne
                        const cellule = (row[0] || '').toString();
                        const refMatch = cellule.match(/\[(\w+)\]/);
                        
                        if (refMatch) {
                            const ref = refMatch[1];
                            const produit = trouverProduit(ref);
                            
                            if (produit) {
                                if (!consoParProduit[produit.refFR]) {
                                    consoParProduit[produit.refFR] = [];
                                }
                                
                                // Lire les valeurs pour chaque mois
                                for (const colIndex in colonnesMois) {
                                    const valeur = row[colIndex];
                                    if (valeur && valeur !== '' && !isNaN(parseFloat(valeur))) {
                                        consoParProduit[produit.refFR].push({
                                            date: colonnesMois[colIndex],
                                            qte: parseFloat(valeur)
                                        });
                                    }
                                }
                            } else {
                                console.warn(`R√©f√©rence non trouv√©e: ${ref}`);
                            }
                        }
                    }

                    // Calculer la moyenne des 12 derniers mois pour chaque produit
                    const maintenant = new Date();
                    const il_y_a_12_mois = new Date(maintenant.getFullYear(), maintenant.getMonth() - 12, 1);

                    let imported = 0;
                    let errors = 0;

                    for (const refFR in consoParProduit) {
                        const consos = consoParProduit[refFR];
                        
                        // Filtrer les 12 derniers mois
                        const consos12Mois = consos.filter(c => c.date >= il_y_a_12_mois && c.date <= maintenant);
                        
                        if (consos12Mois.length > 0) {
                            // Calculer la moyenne
                            const total = consos12Mois.reduce((sum, c) => sum + c.qte, 0);
                            const moyenne = total / consos12Mois.length;
                            
                            database.conso[refFR] = Math.round(moyenne * 100) / 100; // Arrondir √† 2 d√©cimales
                            imported++;
                            
                            console.log(`${refFR}: ${consos12Mois.length} mois trouv√©s, total = ${total}, moyenne = ${moyenne.toFixed(2)}`);
                        } else if (consos.length > 0) {
                            // Si pas de donn√©es dans les 12 derniers mois, prendre la moyenne de toutes les donn√©es disponibles
                            const total = consos.reduce((sum, c) => sum + c.qte, 0);
                            const moyenne = total / consos.length;
                            database.conso[refFR] = Math.round(moyenne * 100) / 100;
                            imported++;
                            console.log(`${refFR}: Aucune donn√©e dans les 12 derniers mois, moyenne sur ${consos.length} mois = ${moyenne.toFixed(2)}`);
                        } else {
                            errors++;
                            console.warn(`${refFR}: Aucune donn√©e trouv√©e`);
                        }
                    }

                    sauvegarderDonnees();
                    afficherEtatImports();
                    
                    let message = `‚úÖ Import termin√©!\n\n`;
                    message += `‚Ä¢ ${imported} produits import√©s (moyenne calcul√©e)\n`;
                    if (errors > 0) {
                        message += `‚Ä¢ ${errors} produits sans donn√©es\n`;
                    }
                    message += `\nüìÖ P√©riode analys√©e: ${il_y_a_12_mois.toLocaleDateString('fr-FR', {month: 'long', year: 'numeric'})} √† ${maintenant.toLocaleDateString('fr-FR', {month: 'long', year: 'numeric'})}`;
                    message += `\nüìä Colonnes de mois d√©tect√©es: ${Object.keys(colonnesMois).length}`;
                    
                    alert(message);
                } catch (error) {
                    console.error('Erreur import conso:', error);
                    alert('‚ùå Erreur lors de la lecture du fichier:\n' + error.message + '\n\nFormat attendu: Colonne A avec [R√©f√©rence] et colonnes avec mois (ex: janvier 2024, f√©vrier 2024...)');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function importerForecast() {
            const fileInput = document.getElementById('fileForecast');
            if (!fileInput.files.length) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(firstSheet, {raw: false, defval: ''});

                    console.log('Import forecast - Nombre de lignes:', rows.length);
                    console.log('Colonnes disponibles:', Object.keys(rows[0] || {}));

                    // R√©cup√©rer le mois s√©lectionn√© manuellement
                    const moisSelectElement = document.getElementById('moisForecast');
                    const moisActuel = parseInt(moisSelectElement.value);
                    
                    // Mapping des mois avec leurs variantes (y compris avec suffixes .1, .2, etc.)
                    const moisInitiales = ['J', 'F', 'M', 'A', 'M', 'J', 'J', 'A', 'S', 'O', 'N', 'D'];
                    const initialeAttendue = moisInitiales[moisActuel];
                    
                    // Mapping complet des mois
                    const moisNoms = {
                        0: ['J', 'j', 'Jan', 'Janvier', 'janvier', 'JAN', 'JANVIER', '01', '1'],
                        1: ['F', 'f', 'F√©v', 'Fev', 'F√©vrier', 'Fevrier', 'f√©vrier', 'fevrier', 'FEV', 'FEVRIER', '02', '2'],
                        2: ['M', 'm', 'Mar', 'Mars', 'mars', 'MAR', 'MARS', '03', '3'],
                        3: ['A', 'a', 'Avr', 'Avril', 'avril', 'AVR', 'AVRIL', '04', '4'],
                        4: ['M', 'm', 'M.1', 'M.2', 'Mai', 'mai', 'MAI', '05', '5'],
                        5: ['J', 'j', 'J.1', 'J.2', 'Jun', 'Juin', 'juin', 'JUN', 'JUIN', '06', '6'],
                        6: ['J', 'j', 'J.1', 'J.2', 'Jul', 'Juil', 'Juillet', 'juillet', 'JUL', 'JUILLET', '07', '7'],
                        7: ['A', 'a', 'A.1', 'A.2', 'Ao√ª', 'Aou', 'Ao√ªt', 'Aout', 'ao√ªt', 'aout', 'AOU', 'AOUT', '08', '8'],
                        8: ['S', 's', 'Sep', 'Sept', 'Septembre', 'septembre', 'SEP', 'SEPTEMBRE', '09', '9'],
                        9: ['O', 'o', 'Oct', 'Octobre', 'octobre', 'OCT', 'OCTOBRE', '10'],
                        10: ['N', 'n', 'Nov', 'Novembre', 'novembre', 'NOV', 'NOVEMBRE', '11'],
                        11: ['D', 'd', 'D√©c', 'Dec', 'D√©cembre', 'Decembre', 'd√©cembre', 'decembre', 'DEC', 'DECEMBRE', '12']
                    };

                    // Trouver la colonne correspondant au mois s√©lectionn√©
                    let colonneMonth = null;
                    const colonnes = Object.keys(rows[0] || {});
                    
                    // Compter combien de fois chaque initiale appara√Æt pour d√©terminer le bon suffixe
                    const compteurInitiales = {};
                    const positionsInitiales = {};
                    
                    // Identifier les positions de chaque initiale
                    colonnes.forEach((col, index) => {
                        const colTrimmed = col.toString().trim();
                        
                        // IMPORTANT: Ne prendre que les colonnes d'une seule lettre OU avec suffixe .1, .2, etc.
                        // Pour √©viter de prendre "D√©signation" pour "D"
                        const estColonneMois = /^[JFMASOND](\.\d+)?$/i.test(colTrimmed);
                        
                        if (estColonneMois) {
                            const initiale = colTrimmed.charAt(0).toUpperCase();
                            
                            if (!compteurInitiales[initiale]) {
                                compteurInitiales[initiale] = 0;
                                positionsInitiales[initiale] = [];
                            }
                            positionsInitiales[initiale].push({col: col, index: index});
                            compteurInitiales[initiale]++;
                        }
                    });

                    console.log('Compteur initiales:', compteurInitiales);
                    console.log('Positions:', positionsInitiales);

                    // Mapping des mois vers leur position dans l'ann√©e
                    const positionsMois = {
                        0: 0, 1: 1, 2: 2, 3: 3, 4: 4, 5: 5, 6: 6, 7: 7, 8: 8, 9: 9, 10: 10, 11: 11
                    };
                    
                    // D√©terminer quelle colonne correspond au mois s√©lectionn√©
                    // Pour Mai (4), Juin (5), Juillet (6), Ao√ªt (7) qui ont des homonymes
                    if (moisActuel === 4 && positionsInitiales['M']) { // Mai
                        const posM = positionsInitiales['M'];
                        if (posM.length > 1) {
                            colonneMonth = posM[1].col; // Deuxi√®me M = Mai
                        } else {
                            colonneMonth = posM[0].col; // S'il n'y a qu'un M
                        }
                    } else if (moisActuel === 5 && positionsInitiales['J']) { // Juin
                        const posJ = positionsInitiales['J'];
                        if (posJ.length > 1) {
                            colonneMonth = posJ[1].col; // Deuxi√®me J = Juin
                        } else {
                            colonneMonth = posJ[0].col;
                        }
                    } else if (moisActuel === 6 && positionsInitiales['J']) { // Juillet
                        const posJ = positionsInitiales['J'];
                        if (posJ.length > 2) {
                            colonneMonth = posJ[2].col; // Troisi√®me J = Juillet
                        } else if (posJ.length > 1) {
                            colonneMonth = posJ[1].col;
                        } else {
                            colonneMonth = posJ[0].col;
                        }
                    } else if (moisActuel === 7 && positionsInitiales['A']) { // Ao√ªt
                        const posA = positionsInitiales['A'];
                        if (posA.length > 1) {
                            colonneMonth = posA[1].col; // Deuxi√®me A = Ao√ªt
                        } else {
                            colonneMonth = posA[0].col;
                        }
                    } else {
                        // Pour les autres mois (pas d'ambigu√Øt√©)
                        // Utiliser la m√™me logique que ci-dessus: chercher dans positionsInitiales
                        const initialeAttendue = moisInitiales[moisActuel];
                        if (positionsInitiales[initialeAttendue] && positionsInitiales[initialeAttendue].length > 0) {
                            colonneMonth = positionsInitiales[initialeAttendue][0].col;
                        }
                    }

                    if (!colonneMonth) {
                        const moisTexte = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                          'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'][moisActuel];
                        alert(`‚ö†Ô∏è Aucune colonne trouv√©e pour le mois s√©lectionn√© (${moisTexte}).\n\nColonnes disponibles: ${colonnes.join(', ')}\n\nV√©rifiez que votre fichier contient bien une colonne pour ${moisTexte}.`);
                        return;
                    }

                    let imported = 0;
                    let errors = 0;

                    rows.forEach(row => {
                        // D√©tecter la r√©f√©rence FR en priorit√©
                        let refFR = row['r√©f FR'] || row['R√©f FR'] || row['Ref FR'] || row['REF FR'] ||
                                    row['R√©f√©rence FR'] || row['Reference FR'] || row['RefFR'];
                        
                        // Si pas de r√©f FR, chercher la r√©f ALL
                        let refALL = row['r√©f all'] || row['R√©f ALL'] || row['Ref ALL'] || row['REF ALL'] ||
                                     row['R√©f√©rence ALL'] || row['Reference ALL'] || row['RefALL'];
                        
                        const forecast = row[colonneMonth];

                        if (forecast !== undefined && forecast !== '' && forecast !== null) {
                            let produit = null;
                            
                            // Essayer d'abord avec la r√©f FR
                            if (refFR && refFR !== 'NaN' && refFR !== 'nan') {
                                produit = trouverProduit(refFR.toString().trim());
                            }
                            
                            // Si pas trouv√© avec r√©f FR, essayer avec r√©f ALL
                            if (!produit && refALL && refALL !== 'NaN' && refALL !== 'nan') {
                                produit = trouverProduit(refALL.toString().trim());
                            }
                            
                            if (produit) {
                                const forecastValue = parseFloat(forecast);
                                if (!isNaN(forecastValue)) {
                                    database.forecast[produit.refFR] = forecastValue;
                                    imported++;
                                }
                            } else {
                                errors++;
                            }
                        }
                    });

                    sauvegarderDonnees();
                    afficherEtatImports();
                    
                    const moisTexte = ['Janvier', 'F√©vrier', 'Mars', 'Avril', 'Mai', 'Juin', 
                                      'Juillet', 'Ao√ªt', 'Septembre', 'Octobre', 'Novembre', 'D√©cembre'][moisActuel];
                    
                    let message = `‚úÖ Import termin√©!\n\n`;
                    message += `üìÖ Mois s√©lectionn√©: ${moisTexte}\n`;
                    message += `üìä Colonne utilis√©e: "${colonneMonth}"\n\n`;
                    message += `‚Ä¢ ${imported} produits import√©s\n`;
                    if (errors > 0) {
                        message += `‚Ä¢ ${errors} r√©f√©rences non trouv√©es\n`;
                    }
                    
                    alert(message);
                } catch (error) {
                    console.error('Erreur import forecast:', error);
                    alert('‚ùå Erreur lors de la lecture du fichier:\n' + error.message + '\n\nFormat attendu: R√©f FR | J | F | M | A | M | J | J | A | S | O | N | D');
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function afficherEtatImports() {
            const container = document.getElementById('etatImports');
            
            const nbStock = Object.keys(database.stocks).length;
            const nbConso = Object.keys(database.conso).length;
            const nbForecast = Object.keys(database.forecast).length;
            const nbProduits = database.produits.length;

            let html = '<div class="stats-grid">';
            html += `<div class="stat-card"><h3>Produits au r√©f√©rentiel</h3><div class="value">${nbProduits}</div></div>`;
            html += `<div class="stat-card"><h3>Stock import√©s</h3><div class="value">${nbStock}</div></div>`;
            html += `<div class="stat-card"><h3>Conso import√©es</h3><div class="value">${nbConso}</div></div>`;
            html += `<div class="stat-card"><h3>Forecast import√©s</h3><div class="value">${nbForecast}</div></div>`;
            html += '</div>';

            container.innerHTML = html;
        }

        // CALCUL COMMANDE
        function calculerCommande() {
            if (database.produits.length === 0) {
                alert('‚ö†Ô∏è Aucun produit dans le r√©f√©rentiel');
                return;
            }

            database.commande = {};
            let produitsCalcules = 0;
            let produitsForecastOnly = 0;

            database.produits.forEach(produit => {
                const stock = database.stocks[produit.refFR] || 0;
                const conso = database.conso[produit.refFR] || 0;
                const forecast = database.forecast[produit.refFR] || 0;
                const colisage = produit.colisage || null;

                // V√©rifier si ce produit est en mode "forecast only"
                const isForecastOnly = estForecastOnly(produit.refFR);

                let consoSur20Jours, stockAuJourReception, besoin, qteCalculee, qteCommande;

                if (isForecastOnly) {
                    // MODE FORECAST ONLY : Commande = Forecast uniquement
                    consoSur20Jours = 0;
                    stockAuJourReception = stock;
                    besoin = 0;
                    // Arrondir le forecast au sup√©rieur
                    qteCalculee = Math.ceil(forecast);
                    qteCommande = Math.max(0, Math.ceil(forecast));
                    produitsForecastOnly++;
                } else {
                    // MODE NORMAL : Formule compl√®te avec d√©lai de 20 jours
                    // 1. Calculer la conso sur 20 jours (entre le 15 et le 5 du mois suivant)
                    consoSur20Jours = Math.ceil((conso / 30) * 20);
                    
                    // 2. Stock pr√©visionnel au 5 novembre (date de r√©ception)
                    stockAuJourReception = Math.ceil(stock - consoSur20Jours);
                    
                    // 3. Besoin = 2 mois de stock - ARRONDI AU SUP√âRIEUR
                    besoin = Math.ceil(2 * conso);
                    
                    // 4. Quantit√© √† commander = Besoin - Stock au jour r√©ception + Forecast
                    qteCalculee = besoin - stockAuJourReception + forecast;
                    qteCommande = Math.max(0, Math.ceil(qteCalculee)); // Arrondir au sup√©rieur et minimum 0
                }

                // 5. Calculer la quantit√© en colis si colisage d√©fini
                let qteEnColis = null;
                if (colisage && colisage > 0) {
                    qteEnColis = Math.ceil(qteCommande / colisage);
                }

                database.commande[produit.refFR] = {
                    stock,
                    conso: Math.ceil(conso),
                    forecast,
                    consoSur20Jours,
                    stockAuJourReception,
                    besoin,
                    qteCommande,
                    qteEnColis,
                    forecastOnly: isForecastOnly
                };

                produitsCalcules++;
            });

            sauvegarderDonnees();
            afficherResultatCalcul();
            
            let message = `‚úÖ Calcul termin√© pour ${produitsCalcules} produits !\n\n`;
            message += `üìÖ Commande pass√©e le 15 ‚Üí R√©ception le 5\n`;
            message += `‚è±Ô∏è Consommation sur 20 jours prise en compte\n`;
            message += `üîº Tous les arrondis au sup√©rieur`;
            
            if (produitsForecastOnly > 0) {
                message += `\n\n‚öôÔ∏è ${produitsForecastOnly} produit(s) en mode "Forecast Only"`;
            }
            
            alert(message);
        }

        function afficherResultatCalcul() {
            const container = document.getElementById('resultatCalcul');
            
            if (Object.keys(database.commande).length === 0) {
                container.innerHTML = '<div class="empty-state">üßÆ Cliquez sur "Calculer les besoins" pour g√©n√©rer la commande</div>';
                return;
            }

            let montantTotal = 0;

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>R√©f FR</th>
                            <th>R√©f ALL</th>
                            <th>D√©signation</th>
                            <th>Stock actuel</th>
                            <th>Conso/mois</th>
                            <th>Conso 20j</th>
                            <th>Stock au 5/11</th>
                            <th>Forecast</th>
                            <th>Besoin (2 mois)</th>
                            <th>Qt√© √† commander</th>
                            <th>Colisage</th>
                            <th>Qt√© en colis</th>
                            <th>Prix unitaire</th>
                            <th>Montant total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            database.produits.forEach(produit => {
                const calcul = database.commande[produit.refFR];
                if (!calcul) return;

                const prixUnitaire = produit.prixAchat || 0;
                const montantLigne = calcul.qteCommande * prixUnitaire;
                montantTotal += montantLigne;

                const rowClass = calcul.qteCommande > 0 ? (calcul.qteCommande > 100 ? 'highlight-red' : 'highlight-yellow') : 'highlight-green';

                html += `
                    <tr class="${rowClass}">
                        <td><strong>${produit.refFR}${calcul.forecastOnly ? ' üéØ' : ''}</strong></td>
                        <td>${produit.refALL}</td>
                        <td>${produit.designation}${calcul.forecastOnly ? ' <span style="color: #667eea; font-weight: bold;">(Forecast Only)</span>' : ''}</td>
                        <td>${calcul.stock}</td>
                        <td>${calcul.forecastOnly ? '-' : calcul.conso}</td>
                        <td>${calcul.forecastOnly ? '-' : calcul.consoSur20Jours}</td>
                        <td>${calcul.forecastOnly ? '-' : calcul.stockAuJourReception}</td>
                        <td>${calcul.forecast}</td>
                        <td>${calcul.forecastOnly ? '-' : calcul.besoin}</td>
                        <td><strong>${calcul.qteCommande}</strong></td>
                        <td>${produit.colisage || '-'}</td>
                        <td><strong style="color: #667eea;">${calcul.qteEnColis ? calcul.qteEnColis + ' colis' : '-'}</strong></td>
                        <td>${prixUnitaire ? prixUnitaire.toFixed(2) + ' ‚Ç¨' : '-'}</td>
                        <td><strong>${montantLigne > 0 ? montantLigne.toFixed(2) + ' ‚Ç¨' : '-'}</strong></td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td colspan="13" style="text-align: right; padding: 15px;">MONTANT TOTAL DE LA COMMANDE:</td>
                            <td style="font-size: 1.2em; color: #667eea;">${montantTotal.toFixed(2)} ‚Ç¨</td>
                        </tr>
                    </tfoot>
                </table>
            `;
            container.innerHTML = html;
        }

        // Fonction pour rendre les colonnes redimensionnables
        function makeColumnsResizable(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const cols = table.querySelectorAll('th');
            
            cols.forEach((col, index) => {
                const resizer = col.querySelector('.resizer');
                if (!resizer) return;

                let startX, startWidth, colIndex;

                resizer.addEventListener('mousedown', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    startX = e.pageX;
                    startWidth = col.offsetWidth;
                    colIndex = index;
                    
                    // Ajouter une classe pour indiquer qu'on est en train de redimensionner
                    resizer.style.background = 'rgba(255, 255, 255, 0.5)';
                    document.body.style.cursor = 'col-resize';
                    
                    document.addEventListener('mousemove', resize);
                    document.addEventListener('mouseup', stopResize);
                });

                function resize(e) {
                    const diff = e.pageX - startX;
                    const newWidth = Math.max(50, startWidth + diff); // Largeur minimum de 50px
                    
                    // Appliquer la largeur √† l'en-t√™te
                    col.style.width = newWidth + 'px';
                    col.style.minWidth = newWidth + 'px';
                    col.style.maxWidth = newWidth + 'px';
                    
                    // Appliquer aussi √† toutes les cellules de cette colonne
                    const rows = table.querySelectorAll('tbody tr, tfoot tr');
                    rows.forEach(row => {
                        const cell = row.cells[colIndex];
                        if (cell) {
                            cell.style.width = newWidth + 'px';
                            cell.style.minWidth = newWidth + 'px';
                            cell.style.maxWidth = newWidth + 'px';
                        }
                    });
                }

                function stopResize() {
                    document.removeEventListener('mousemove', resize);
                    document.removeEventListener('mouseup', stopResize);
                    resizer.style.background = '';
                    document.body.style.cursor = '';
                }
            });
        }

        function exporterCommande() {
            if (Object.keys(database.commande).length === 0) {
                alert('‚ö†Ô∏è Veuillez d\'abord calculer la commande');
                return;
            }

            const data = [];
            let montantTotal = 0;

            database.produits.forEach(produit => {
                const calcul = database.commande[produit.refFR];
                if (calcul && calcul.qteCommande > 0) {
                    const prixUnitaire = produit.prixAchat || 0;
                    const montantLigne = calcul.qteCommande * prixUnitaire;
                    montantTotal += montantLigne;

                    data.push({
                        'R√©f FR': produit.refFR,
                        'R√©f ALL': produit.refALL,
                        'D√©signation': produit.designation,
                        'Stock actuel': calcul.stock,
                        'Conso mensuelle': calcul.conso,
                        'Conso 20 jours': calcul.consoSur20Jours,
                        'Stock au 5/11': calcul.stockAuJourReception,
                        'Forecast': calcul.forecast,
                        'Besoin (2 mois)': calcul.besoin,
                        'Quantit√© √† commander': calcul.qteCommande,
                        'Colisage': produit.colisage || '',
                        'Qt√© en colis': calcul.qteEnColis || '',
                        'Prix unitaire': prixUnitaire,
                        'Montant total': montantLigne.toFixed(2)
                    });
                }
            });

            // Ajouter une ligne de total
            data.push({
                'R√©f FR': '',
                'R√©f ALL': '',
                'D√©signation': '',
                'Stock actuel': '',
                'Conso mensuelle': '',
                'Conso 20 jours': '',
                'Stock au 5/11': '',
                'Forecast': '',
                'Besoin (2 mois)': '',
                'Quantit√© √† commander': '',
                'Colisage': '',
                'Qt√© en colis': '',
                'Prix unitaire': 'TOTAL:',
                'Montant total': montantTotal.toFixed(2)
            });

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Commande");
            
            const date = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `commande_${date}.xlsx`);
            
            alert(`‚úÖ Fichier de commande export√© !\n\nMontant total: ${montantTotal.toFixed(2)} ‚Ç¨`);
        }

        // ORDER CONFIRMATION
        function importerConfirmation() {
            const fileInput = document.getElementById('fileConfirmation');
            if (!fileInput.files.length) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner un fichier');
                return;
            }

            if (Object.keys(database.commande).length === 0) {
                alert('‚ö†Ô∏è Vous devez d\'abord calculer une commande');
                return;
            }

            const file = fileInput.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    
                    // Lire avec l'option header: 1 pour avoir les donn√©es par index de colonne
                    const rowsArray = XLSX.utils.sheet_to_json(firstSheet, {header: 1, raw: false, defval: ''});

                    console.log('Import confirmation - Nombre de lignes:', rowsArray.length);
                    console.log('Premi√®re ligne (en-t√™tes):', rowsArray[0]);

                    database.confirmation = {};
                    database.confirmationDetails = {}; // Nouvelle structure pour stocker J et K s√©par√©ment
                    let imported = 0;
                    let errors = 0;

                    // Commencer √† la ligne 2 (index 1) pour sauter les en-t√™tes
                    for (let i = 1; i < rowsArray.length; i++) {
                        const row = rowsArray[i];
                        
                        // Colonne G = index 6 (Article-No. / R√©f ALL)
                        // Colonne J = index 9 (Quantity order)
                        // Colonne K = index 10 (Quantity available)
                        const refALL = row[6]; // Colonne G
                        const qtyOrder = row[9]; // Colonne J
                        const qtyAvailable = row[10]; // Colonne K

                        if (refALL && refALL !== '') {
                            const refStr = refALL.toString().trim();
                            const produit = database.produits.find(p => p.refALL === refStr);
                            
                            if (produit) {
                                const qtyOrderValue = qtyOrder !== undefined && qtyOrder !== '' && qtyOrder !== null ? parseFloat(qtyOrder) : 0;
                                const qtyAvailableValue = qtyAvailable !== undefined && qtyAvailable !== '' && qtyAvailable !== null ? parseFloat(qtyAvailable) : 0;
                                
                                if (!isNaN(qtyOrderValue) || !isNaN(qtyAvailableValue)) {
                                    // Stocker la quantit√© confirm√©e (colonne J)
                                    database.confirmation[produit.refFR] = qtyOrderValue;
                                    
                                    // Stocker les d√©tails (J et K s√©par√©ment)
                                    database.confirmationDetails[produit.refFR] = {
                                        qtyOrder: qtyOrderValue,
                                        qtyAvailable: qtyAvailableValue
                                    };
                                    
                                    imported++;
                                    console.log(`‚úì ${produit.refFR} (${refStr}): Order=${qtyOrderValue}, Available=${qtyAvailableValue}`);
                                }
                            } else {
                                errors++;
                                console.warn(`R√©f√©rence ALL non trouv√©e: ${refStr}`);
                            }
                        }
                    }

                    sauvegarderDonnees();
                    comparerConfirmation();
                    
                    let message = `‚úÖ Import termin√©!\n\n`;
                    message += `‚Ä¢ ${imported} produits confirm√©s\n`;
                    if (errors > 0) {
                        message += `‚Ä¢ ${errors} r√©f√©rences ALL non trouv√©es dans le r√©f√©rentiel\n`;
                    }
                    message += `\nüìä Colonnes utilis√©es:\n`;
                    message += `  ‚Ä¢ G (Article-No. / R√©f ALL)\n`;
                    message += `  ‚Ä¢ J (Quantity order)\n`;
                    message += `  ‚Ä¢ K (Quantity available)`;
                    
                    alert(message);
                } catch (error) {
                    console.error('Erreur import confirmation:', error);
                    alert('‚ùå Erreur lors de la lecture du fichier:\n' + error.message);
                }
            };

            reader.readAsArrayBuffer(file);
        }

        function comparerConfirmation() {
            const container = document.getElementById('resultatConfirmation');

            let nbOK = 0;
            let nbManquant = 0;
            let nbPartiel = 0;
            let montantCommande = 0;
            let montantConfirme = 0;

            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>R√©f FR</th>
                            <th>R√©f ALL</th>
                            <th>D√©signation</th>
                            <th>Qt√© Command√©e</th>
                            <th>Qt√© Confirm√©e</th>
                            <th>√âcart Confirm√©</th>
                            <th>Qt√© Disponible</th>
                            <th>√âcart Disponible</th>
                            <th>Prix unitaire</th>
                            <th>Montant Command√©</th>
                            <th>Montant Confirm√©</th>
                            <th>√âcart ‚Ç¨</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            database.produits.forEach(produit => {
                const commande = database.commande[produit.refFR];
                if (!commande || commande.qteCommande === 0) return;

                const qteCommande = commande.qteCommande;
                
                // R√©cup√©rer les d√©tails de la confirmation (colonnes J et K)
                const details = database.confirmationDetails[produit.refFR] || { qtyOrder: 0, qtyAvailable: 0 };
                const qteConfirmee = details.qtyOrder; // Colonne J
                const qteDisponible = details.qtyAvailable; // Colonne K
                
                const ecartQteConfirmee = qteConfirmee - qteCommande;
                const ecartQteDisponible = qteDisponible - qteCommande;
                
                const prixUnitaire = produit.prixAchat || 0;
                const montantLigneCommande = qteCommande * prixUnitaire;
                const montantLigneConfirme = qteConfirmee * prixUnitaire;
                const ecartMontant = montantLigneConfirme - montantLigneCommande;

                montantCommande += montantLigneCommande;
                montantConfirme += montantLigneConfirme;

                let statut = '';
                let rowClass = '';

                if (qteConfirmee === 0) {
                    statut = '‚ùå Non confirm√©';
                    rowClass = 'highlight-red';
                    nbManquant++;
                } else if (qteConfirmee < qteCommande) {
                    statut = '‚ö†Ô∏è Partiel';
                    rowClass = 'highlight-yellow';
                    nbPartiel++;
                } else {
                    statut = '‚úÖ OK';
                    rowClass = 'highlight-green';
                    nbOK++;
                }

                html += `
                    <tr class="${rowClass}">
                        <td><strong>${produit.refFR}</strong></td>
                        <td>${produit.refALL}</td>
                        <td>${produit.designation}</td>
                        <td>${qteCommande}</td>
                        <td>${qteConfirmee}</td>
                        <td><strong style="color: ${ecartQteConfirmee < 0 ? '#dc3545' : ecartQteConfirmee > 0 ? '#28a745' : '#666'};">${ecartQteConfirmee > 0 ? '+' : ''}${ecartQteConfirmee}</strong></td>
                        <td>${qteDisponible}</td>
                        <td><strong style="color: ${ecartQteDisponible < 0 ? '#dc3545' : ecartQteDisponible > 0 ? '#28a745' : '#666'};">${ecartQteDisponible > 0 ? '+' : ''}${ecartQteDisponible}</strong></td>
                        <td>${prixUnitaire ? prixUnitaire.toFixed(2) + ' ‚Ç¨' : '-'}</td>
                        <td>${montantLigneCommande.toFixed(2)} ‚Ç¨</td>
                        <td>${montantLigneConfirme.toFixed(2)} ‚Ç¨</td>
                        <td><strong style="color: ${ecartMontant < 0 ? '#dc3545' : ecartMontant > 0 ? '#28a745' : '#666'};">${ecartMontant > 0 ? '+' : ''}${ecartMontant.toFixed(2)} ‚Ç¨</strong></td>
                        <td>${statut}</td>
                    </tr>
                `;
            });

            const ecartTotal = montantConfirme - montantCommande;

            html += `
                    </tbody>
                    <tfoot>
                        <tr style="background: #f0f0f0; font-weight: bold;">
                            <td colspan="9" style="text-align: right; padding: 15px;">TOTAUX:</td>
                            <td style="color: #667eea;">${montantCommande.toFixed(2)} ‚Ç¨</td>
                            <td style="color: ${montantConfirme >= montantCommande ? '#28a745' : '#dc3545'};">${montantConfirme.toFixed(2)} ‚Ç¨</td>
                            <td style="font-size: 1.1em; color: ${ecartTotal < 0 ? '#dc3545' : ecartTotal > 0 ? '#28a745' : '#666'};">${ecartTotal > 0 ? '+' : ''}${ecartTotal.toFixed(2)} ‚Ç¨</td>
                            <td></td>
                        </tr>
                    </tfoot>
                </table>
            `;

            const resume = `
                <div class="stats-grid">
                    <div class="stat-card"><h3>‚úÖ Confirm√©s OK</h3><div class="value" style="color: #28a745;">${nbOK}</div></div>
                    <div class="stat-card"><h3>‚ö†Ô∏è Partiels</h3><div class="value" style="color: #ffc107;">${nbPartiel}</div></div>
                    <div class="stat-card"><h3>‚ùå Non confirm√©s</h3><div class="value" style="color: #dc3545;">${nbManquant}</div></div>
                    <div class="stat-card">
                        <h3>üí∞ √âcart financier</h3>
                        <div class="value" style="color: ${ecartTotal < 0 ? '#dc3545' : ecartTotal > 0 ? '#28a745' : '#667eea'};">
                            ${ecartTotal > 0 ? '+' : ''}${ecartTotal.toFixed(2)} ‚Ç¨
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = resume + html;
        }

        // DASHBOARD
        function afficherDashboard() {
            afficherStats();
            afficherTableauComplet();
        }

        function afficherStats() {
            const container = document.getElementById('statsGrid');
            
            const nbProduits = database.produits.length;
            const stockTotal = Object.values(database.stocks).reduce((a, b) => a + b, 0);
            const consoTotale = Object.values(database.conso).reduce((a, b) => a + b, 0);
            const forecastTotal = Object.values(database.forecast).reduce((a, b) => a + b, 0);

            let html = '';
            html += `<div class="stat-card"><h3>üì¶ Produits r√©f√©renc√©s</h3><div class="value">${nbProduits}</div></div>`;
            html += `<div class="stat-card"><h3>üìä Stock total</h3><div class="value">${Math.round(stockTotal)}</div></div>`;
            html += `<div class="stat-card"><h3>üìâ Conso mensuelle totale</h3><div class="value">${Math.round(consoTotale)}</div></div>`;
            html += `<div class="stat-card"><h3>üìà Forecast total</h3><div class="value">${Math.round(forecastTotal)}</div></div>`;

            container.innerHTML = html;
        }

        function afficherTableauComplet() {
            const container = document.getElementById('tableauComplet');
            
            if (database.produits.length === 0) {
                container.innerHTML = '<div class="empty-state">üì¶ Aucune donn√©e √† afficher</div>';
                return;
            }

            let html = `
                <table id="dashboardTable">
                    <thead>
                        <tr>
                            <th>R√©f FR</th>
                            <th>R√©f ALL</th>
                            <th>D√©signation</th>
                            <th>Stock</th>
                            <th>Conso</th>
                            <th>Forecast</th>
                            <th>√Ä commander</th>
                            <th>Confirm√©</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            database.produits.forEach(produit => {
                const stock = database.stocks[produit.refFR] || 0;
                const conso = database.conso[produit.refFR] || 0;
                const forecast = database.forecast[produit.refFR] || 0;
                const commande = database.commande[produit.refFR]?.qteCommande || 0;
                const confirme = database.confirmation[produit.refFR] || 0;

                html += `
                    <tr>
                        <td><strong>${produit.refFR}</strong></td>
                        <td>${produit.refALL}</td>
                        <td>${produit.designation}</td>
                        <td>${stock}</td>
                        <td>${conso}</td>
                        <td>${forecast}</td>
                        <td>${commande}</td>
                        <td>${confirme}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function filtrerDashboard() {
            const search = document.getElementById('searchDashboard').value.toLowerCase();
            const rows = document.querySelectorAll('#dashboardTable tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        // IMPORT/EXPORT R√âF√âRENTIEL
        function importerReferentiel() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx,.xls';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();

                reader.onload = function(event) {
                    try {
                        const data = new Uint8Array(event.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const rows = XLSX.utils.sheet_to_json(firstSheet, {raw: false, defval: ''});

                        console.log('Fichier charg√©, nombre de lignes:', rows.length);
                        console.log('Exemple de ligne:', rows[0]);

                        let imported = 0;
                        let skipped = 0;
                        let errors = [];

                        rows.forEach((row, index) => {
                            // Essayer diff√©rentes variations de noms de colonnes
                            const refFR = row['R√©f FR'] || row['Ref FR'] || row['REF FR'] || 
                                         row['ref fr'] || row['R√©f√©rence FR'] || row['Reference FR'] ||
                                         row['RefFR'] || row['R√©fFR'] || row['R√©f√©rence'] || row['Reference'] ||
                                         row['R√©f'] || row['Ref'] || row['Code'];
                            
                            const refALL = row['R√©f ALL'] || row['Ref ALL'] || row['REF ALL'] || 
                                          row['ref all'] || row['R√©f√©rence ALL'] || row['Reference ALL'] ||
                                          row['RefALL'] || row['R√©fALL'] || row['R√©f DE'] || row['Ref DE'] ||
                                          row['Reference DE'] || row['R√©f√©rence DE'];
                            
                            const designation = row['D√©signation'] || row['Designation'] || row['DESIGNATION'] ||
                                              row['designation'] || row['Nom'] || row['nom'] || row['Produit'] ||
                                              row['Description'] || row['description'];
                            
                            const prixAchat = row['Prix d\'achat'] || row['Prix d achat'] || row['Prix'] || 
                                            row['prix'] || row['Prix Achat'] || row['prix achat'] ||
                                            row['PA'] || row['pa'] || row['PRIX'];
                            
                            const colisage = row['Colisage'] || row['colisage'] || row['COLISAGE'] ||
                                           row['Conditionnement'] || row['conditionnement'];

                            // V√©rifier qu'on a au minimum une r√©f√©rence FR et une d√©signation
                            if (refFR && designation) {
                                const refFRStr = refFR.toString().trim();
                                const refALLStr = refALL ? refALL.toString().trim() : ''; // Peut √™tre vide
                                
                                const existe = database.produits.find(p => 
                                    p.refFR === refFRStr || (refALLStr && p.refALL === refALLStr)
                                );
                                
                                if (!existe) {
                                    database.produits.push({
                                        refFR: refFRStr,
                                        refALL: refALLStr || 'N/A',
                                        designation: designation.toString().trim(),
                                        prixAchat: prixAchat ? parseFloat(prixAchat) : null,
                                        colisage: colisage ? parseInt(colisage) : null
                                    });
                                    imported++;
                                    if (!refALLStr) {
                                        console.log(`Produit ${refFRStr} ajout√© sans r√©f√©rence ALL`);
                                    }
                                } else {
                                    skipped++;
                                }
                            } else {
                                errors.push(`Ligne ${index + 2}: donn√©es manquantes (R√©f FR: ${refFR}, D√©signation: ${designation})`);
                            }
                        });

                        sauvegarderDonnees();
                        afficherReferentiel();
                        
                        let message = `‚úÖ Import termin√©!\n\n`;
                        message += `‚Ä¢ ${imported} produits import√©s\n`;
                        if (skipped > 0) message += `‚Ä¢ ${skipped} produits d√©j√† existants (ignor√©s)\n`;
                        if (errors.length > 0) {
                            message += `\n‚ö†Ô∏è ${errors.length} lignes ignor√©es:\n`;
                            message += errors.slice(0, 5).join('\n');
                            if (errors.length > 5) message += `\n... et ${errors.length - 5} autres`;
                        }
                        
                        alert(message);
                    } catch (error) {
                        console.error('Erreur import:', error);
                        alert('‚ùå Erreur lors de la lecture du fichier:\n' + error.message + '\n\nAssurez-vous que votre fichier Excel contient bien au minimum: "R√©f FR" et "D√©signation"');
                    }
                };

                reader.onerror = function(error) {
                    alert('‚ùå Erreur lors de la lecture du fichier');
                    console.error(error);
                };

                reader.readAsArrayBuffer(file);
            };

            input.click();
        }

        function exporterReferentiel() {
            if (database.produits.length === 0) {
                alert('‚ö†Ô∏è Aucun produit √† exporter');
                return;
            }

            const data = database.produits.map(p => ({
                'R√©f FR': p.refFR,
                'R√©f ALL': p.refALL,
                'D√©signation': p.designation,
                'Prix d\'achat': p.prixAchat || '',
                'Colisage': p.colisage || ''
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "R√©f√©rentiel");
            
            XLSX.writeFile(wb, 'referentiel_produits.xlsx');
            alert('‚úÖ R√©f√©rentiel export√© !');
        }

        function reinitialiserDonnees() {
            if (confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir r√©initialiser toutes les donn√©es (sauf le r√©f√©rentiel) ?')) {
                database.stocks = {};
                database.conso = {};
                database.forecast = {};
                database.commande = {};
                database.confirmation = {};
                
                sauvegarderDonnees();
                afficherEtatImports();
                afficherResultatCalcul();
                document.getElementById('resultatConfirmation').innerHTML = '';
                alert('‚úÖ Donn√©es r√©initialis√©es');
            }
        }

        // FONCTIONS ALERTES DE STOCK
        let alertesData = [];

        function calculerAlertes() {
            const dateReceptionInput = document.getElementById('dateReception').value;
            
            if (!dateReceptionInput) {
                alert('‚ö†Ô∏è Veuillez s√©lectionner une date de r√©ception');
                return;
            }

            const dateReception = new Date(dateReceptionInput);
            const dateAujourdhui = new Date();
            dateAujourdhui.setHours(0, 0, 0, 0);
            dateReception.setHours(0, 0, 0, 0);

            // Calculer le nombre de jours jusqu'√† la r√©ception
            const joursAvantReception = Math.ceil((dateReception - dateAujourdhui) / (1000 * 60 * 60 * 24));

            if (joursAvantReception < 0) {
                alert('‚ö†Ô∏è La date de r√©ception doit √™tre dans le futur');
                return;
            }

            alertesData = [];
            let nbRupture = 0;
            let nbAlerte = 0;
            let nbOk = 0;

            database.produits.forEach(produit => {
                const stock = database.stocks[produit.refFR] || 0;
                const consoMensuelle = database.conso[produit.refFR] || 0;
                
                // Calculer la consommation quotidienne (mois de 30 jours)
                const consoQuotidienne = consoMensuelle / 30;
                
                // Calculer la consommation totale jusqu'√† la r√©ception
                const consoJusquaReception = consoQuotidienne * joursAvantReception;
                
                // Calculer le stock pr√©vu √† la date de r√©ception
                const stockPrevu = stock - consoJusquaReception;
                
                // D√©terminer le statut
                let statut = '';
                let couleur = '';
                let icone = '';
                
                if (stock <= 0) {
                    statut = '‚õî Rupture actuelle';
                    couleur = '#dc3545';
                    icone = '‚õî';
                    nbRupture++;
                } else if (stockPrevu <= 0) {
                    const joursAvantRupture = Math.floor(stock / consoQuotidienne);
                    statut = `‚ö†Ô∏è Rupture dans ${joursAvantRupture} jours`;
                    couleur = '#ff9800';
                    icone = '‚ö†Ô∏è';
                    nbAlerte++;
                } else {
                    statut = '‚úÖ Stock suffisant';
                    couleur = '#28a745';
                    icone = '‚úÖ';
                    nbOk++;
                }

                alertesData.push({
                    refFR: produit.refFR,
                    refALL: produit.refALL,
                    designation: produit.designation,
                    stock: stock,
                    consoMensuelle: consoMensuelle,
                    consoQuotidienne: consoQuotidienne.toFixed(2),
                    consoJusquaReception: consoJusquaReception.toFixed(2),
                    stockPrevu: stockPrevu.toFixed(2),
                    statut: statut,
                    couleur: couleur,
                    icone: icone,
                    categorie: stock <= 0 ? 'rupture' : (stockPrevu <= 0 ? 'alerte' : 'ok')
                });
            });

            // Trier par statut (rupture > alerte > ok)
            alertesData.sort((a, b) => {
                if (a.categorie === 'rupture' && b.categorie !== 'rupture') return -1;
                if (a.categorie !== 'rupture' && b.categorie === 'rupture') return 1;
                if (a.categorie === 'alerte' && b.categorie === 'ok') return -1;
                if (a.categorie === 'ok' && b.categorie === 'alerte') return 1;
                return parseFloat(a.stockPrevu) - parseFloat(b.stockPrevu);
            });

            // Afficher les statistiques
            afficherStatsAlertes(nbRupture, nbAlerte, nbOk, joursAvantReception);
            
            // Afficher le tableau
            afficherTableauAlertes();
        }

        function afficherStatsAlertes(nbRupture, nbAlerte, nbOk, jours) {
            const container = document.getElementById('statsAlertes');
            
            let html = '<div class="stats-grid">';
            html += `<div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white;">
                        <h3>‚õî Rupture actuelle</h3>
                        <div class="value">${nbRupture}</div>
                     </div>`;
            html += `<div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%); color: white;">
                        <h3>‚ö†Ô∏è Alerte stock</h3>
                        <div class="value">${nbAlerte}</div>
                     </div>`;
            html += `<div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #218838 100%); color: white;">
                        <h3>‚úÖ Stock OK</h3>
                        <div class="value">${nbOk}</div>
                     </div>`;
            html += `<div class="stat-card">
                        <h3>üìÖ D√©lai r√©ception</h3>
                        <div class="value">${jours} jours</div>
                     </div>`;
            html += '</div>';
            
            container.innerHTML = html;
        }

        function afficherTableauAlertes() {
            const container = document.getElementById('tableauAlertes');
            const filtre = document.getElementById('filtreAlertes').value;
            
            let dataFiltree = alertesData;
            
            if (filtre === 'rupture') {
                dataFiltree = alertesData.filter(p => p.categorie === 'rupture');
            } else if (filtre === 'alerte') {
                dataFiltree = alertesData.filter(p => p.categorie === 'alerte');
            } else if (filtre === 'critique') {
                dataFiltree = alertesData.filter(p => p.categorie === 'rupture' || p.categorie === 'alerte');
            }

            if (dataFiltree.length === 0) {
                container.innerHTML = '<div class="empty-state">‚úÖ Aucun produit dans cette cat√©gorie</div>';
                return;
            }

            let html = `
                <table id="tableAlertes">
                    <thead>
                        <tr>
                            <th>Statut</th>
                            <th>R√©f FR</th>
                            <th>R√©f ALL</th>
                            <th>D√©signation</th>
                            <th>Stock actuel</th>
                            <th>Conso mensuelle</th>
                            <th>Conso quotidienne</th>
                            <th>Conso pr√©vue</th>
                            <th>Stock pr√©vu</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            dataFiltree.forEach(produit => {
                html += `
                    <tr style="border-left: 4px solid ${produit.couleur};">
                        <td><strong style="color: ${produit.couleur};">${produit.icone} ${produit.statut}</strong></td>
                        <td><strong>${produit.refFR}</strong></td>
                        <td>${produit.refALL}</td>
                        <td>${produit.designation}</td>
                        <td style="text-align: right; ${produit.stock <= 0 ? 'color: red; font-weight: bold;' : ''}">${Math.round(produit.stock)}</td>
                        <td style="text-align: right;">${Math.round(produit.consoMensuelle)}</td>
                        <td style="text-align: right;">${produit.consoQuotidienne}</td>
                        <td style="text-align: right;">${produit.consoJusquaReception}</td>
                        <td style="text-align: right; ${parseFloat(produit.stockPrevu) <= 0 ? 'color: red; font-weight: bold;' : 'color: green; font-weight: bold;'}">${produit.stockPrevu}</td>
                    </tr>
                `;
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function filtrerAlertes() {
            const search = document.getElementById('searchAlertes').value.toLowerCase();
            const rows = document.querySelectorAll('#tableAlertes tbody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(search) ? '' : 'none';
            });
        }

        function exporterAlertes() {
            if (alertesData.length === 0) {
                alert('‚ö†Ô∏è Veuillez d\'abord effectuer une analyse');
                return;
            }

            const filtre = document.getElementById('filtreAlertes').value;
            let dataExport = alertesData;
            
            if (filtre === 'rupture') {
                dataExport = alertesData.filter(p => p.categorie === 'rupture');
            } else if (filtre === 'alerte') {
                dataExport = alertesData.filter(p => p.categorie === 'alerte');
            } else if (filtre === 'critique') {
                dataExport = alertesData.filter(p => p.categorie === 'rupture' || p.categorie === 'alerte');
            }

            const data = dataExport.map(p => ({
                'Statut': p.statut,
                'R√©f FR': p.refFR,
                'R√©f ALL': p.refALL,
                'D√©signation': p.designation,
                'Stock actuel': Math.round(p.stock),
                'Conso mensuelle': Math.round(p.consoMensuelle),
                'Conso quotidienne': p.consoQuotidienne,
                'Conso jusqu\'√† r√©ception': p.consoJusquaReception,
                'Stock pr√©vu': p.stockPrevu
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Alertes Stock");
            
            const dateReception = document.getElementById('dateReception').value;
            XLSX.writeFile(wb, `alertes_stock_${dateReception}.xlsx`);
            alert('‚úÖ Alertes export√©es !');
        }
    </script>
</body>
</html>